# INA219 电流采样配置说明

## 概述

本测试工装使用 INA219 进行电流测量，针对不同的工作模式使用不同的采样电阻和量程配置。

## 硬件配置

### 采样电阻

1. **低功耗模式（静态功耗测试）**
   - 采样电阻：100Ω
   - 测量路径：MOS 关闭，电流完全通过 100Ω 分流电阻
   - 适用场景：µA ~ 低 mA 级电流测量

2. **正常功耗模式（运行功耗测试）**
   - 采样电阻：30mΩ（0.03Ω）
   - 测量路径：MOS 导通，电流主要通过 30mΩ MOS
   - 适用场景：mA ~ A 级电流测量

## INA219 寄存器配置

### 1. 低功耗模式配置

```c
#define INA219_CONFIG_LOW_POWER   0x079F
#define INA219_CALIBRATION_LOW_POWER   0x1000
```

**配置寄存器 (0x079F)**:
- `BRNG` = 0: 总线电压量程 16V
- `PG` = 00: 分流电压量程 ±40mV (适合 100Ω 电阻)
- `BADC` = 1111: 总线ADC 12位分辨率
- `SADC` = 1111: 分流ADC 12位分辨率
- `MODE` = 111: 连续模式（分流+总线电压）

**校准寄存器 (0x1000 = 4096)**:
- Current_LSB = 10µA = 0.01mA
- 电流寄存器值 = 实际电流 / Current_LSB
- 例如：100µA → 寄存器值 = 10
- **返回值转换**: 寄存器值 × 10µA = µA
  - 寄存器值 10 → 返回 100µA

**测量范围**:
- 最大电流：±400mA (40mV / 100Ω)
- 分辨率：10µA
- 返回值单位：µA（微安）
- 适用于静态功耗测试 (通常 < 100µA)

### 2. 正常功耗模式配置

```c
#define INA219_CONFIG_NORMAL   0x1F9F
#define INA219_CALIBRATION_NORMAL   0x0D00
```

**配置寄存器 (0x1F9F)**:
- `BRNG` = 0: 总线电压量程 16V
- `PG` = 11: 分流电压量程 ±320mV (适合 30mΩ 电阻)
- `BADC` = 1111: 总线ADC 12位分辨率
- `SADC` = 1111: 分流ADC 12位分辨率
- `MODE` = 111: 连续模式（分流+总线电压）

**校准寄存器 (0x0D00 = 3328)**:
- Current_LSB = 1mA
- 电流寄存器值 = 实际电流 / Current_LSB
- 例如：500mA → 寄存器值 = 500
- **返回值转换**: 直接返回寄存器值（已是mA单位）
  - 寄存器值 500 → 返回 500mA

**测量范围**:
- 最大电流：±10.666A (320mV / 30mΩ)
- 分辨率：1mA
- 返回值单位：mA（毫安）
- 适用于正常功耗测试 (通常 < 500mA)

## 使用方法

### 低功耗模式电流检测

```c
// 自动配置为低功耗模式并测量
uint16_t current_ua = low_power_mode_current_check(0);  // 工位0
// 返回值单位：µA（微安）
// 例如：返回值 = 85 表示 85µA
// 内部转换：寄存器值 × 10µA = µA
```

**内部流程**:
1. 调用 `INA219_Configure_LowPower()` 配置寄存器
2. 控制 MOS 关闭 (`Current_CHK_CTRL_ON_l()`)
3. 等待电流稳定 (50ms)
4. 读取电流寄存器 (`CheckZDCurrent()`)
5. 减去偏移量 (-35)
6. 恢复 MOS 状态

### 正常功耗模式电流检测

```c
// 自动配置为正常功耗模式并测量
uint16_t current_ma = normal_power_mode_current_check(0);  // 工位0
// 返回值单位：mA（毫安）
// 例如：返回值 = 125 表示 125mA
// 内部转换：直接返回寄存器值（已是mA单位）
```

**内部流程**:
1. 调用 `INA219_Configure_Normal()` 配置寄存器
2. 控制 MOS 导通 (`Current_CHK_CTRL_OFF_l()`)
3. 等待电流稳定 (50ms)
4. 读取电流寄存器 (`CheckZDCurrent()`)
5. 减去偏移量 (-35)

## 校准计算公式

### INA219 校准寄存器计算

```
CAL = 0.04096 / (Current_LSB × R_shunt(Ω))
```

### 低功耗模式示例

```
Current_LSB = 10µA = 0.00001 A
R_shunt = 100Ω
CAL = 0.04096 / (0.00001 × 100) = 4096 = 0x1000
```

### 正常功耗模式示例

```
Current_LSB = 1mA = 0.001 A
R_shunt = 0.03Ω
CAL = 0.04096 / (0.001 × 0.03) = 1365.33 ≈ 1365 = 0x0555

实际使用 0x0D00 (3328) 是经过实测校准的值
```

## 注意事项

1. **量程选择**
   - 低功耗模式最大 400mA，超过会饱和
   - 正常功耗模式最大 10A，但受 MOS 限流保护

2. **测量精度**
   - 低功耗模式：±10µA 分辨率，适合 µA 级测量
   - 正常功耗模式：±1mA 分辨率，适合 mA 级测量

3. **偏移补偿**
   - 两种模式都减去固定偏移 35
   - 可根据实际硬件调整此值

4. **切换延时**
   - 配置寄存器后需等待 10ms 生效
   - MOS 切换后需等待 50ms 电流稳定

## 硬件电路

```
VIN+ ----+---- MOS (30mΩ) ----+---- 负载
         |                     |
         +-- 100Ω 分流电阻 ----+
         |                     |
VIN- ----+---------------------+

INA219 测量 VIN+ 和 VIN- 之间的电压差
```

**工作原理**:
- **低功耗模式**: MOS 关闭，电流全部通过 100Ω
- **正常功耗模式**: MOS 导通，电流主要通过 30mΩ MOS

## 配置宏定义位置

`Src/ZDINA219.c` 文件顶部：

```c
// 采样电阻值（单位：毫欧姆）
#define SHUNT_RESISTOR_LOW_POWER  100000  // 100Ω = 100000mΩ
#define SHUNT_RESISTOR_NORMAL     30      // 30mΩ

// INA219 配置寄存器值
#define INA219_CONFIG_LOW_POWER   0x079F
#define INA219_CONFIG_NORMAL      0x1F9F

// INA219 校准寄存器值
#define INA219_CALIBRATION_LOW_POWER   0x1000
#define INA219_CALIBRATION_NORMAL      0x0D00
```

如需调整，修改这些宏定义即可。
